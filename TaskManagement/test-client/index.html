<!doctype html>
<html>
<head>
    <!-- Este cliente se conecta a la API y para que pueda verse los resultados
        primero se debe correr la API, hacer el login con usuario y contrasena en el endpoint /api/Auth/login
        pegar el token en Autorizacion para un buen acceso 
        -->
    <!-- Ejecute este codigo con vs code, utilizando la extension live server  -->

    <meta charset="utf-8" />
    <title>Cliente SignalR - Tareas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            margin: 20px;
        }

        pre {
            background: #f5f5f5dd;
            padding: 10px;
            max-height: 300px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <h2>Cliente SignalR - Prueba de Tareas</h2>

    <div>
        <h3>Login</h3>
        <input id="username" placeholder="usuario" value="admin">
        <input id="password" placeholder="password" value="1234" type="password">
        <button id="btnLogin">Login</button>
    </div>

    <div>
        <h3>Conexión SignalR</h3>
        <button id="btnConnect">Conectar a SignalR</button>
        <button id="btnDisconnect">Desconectar</button>
    </div>

    <div>
        <h3>Crear tarea (POST)</h3>
        <button id="btnCreateTask">Crear tarea de prueba</button>
    </div>

    <h3>Notificaciones</h3>
    <pre id="log"></pre>

    <script>
        const apiBaseUrl = "https://localhost:7184";
        const hubUrl = "https://localhost:7184/hubs/tasks";
        let token = localStorage.getItem("token") || null;
        let connection = null;

        const log = msg => {
            const el = document.getElementById("log");
            el.textContent += msg + "\n";
        };


        document.getElementById("btnLogin").addEventListener("click", async () => {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            try {
                const res = await fetch(`${apiBaseUrl}/api/Auth/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });
                if (!res.ok) throw new Error("Login fallido");
                const json = await res.json();
                token = json.token;
                localStorage.setItem("token", token);
                log("Login correcto — token guardado.");
            } catch (e) {
                log("Error login: " + e);
            }
        });


        document.getElementById("btnConnect").addEventListener("click", async () => {
            if (!token) { log("Primero haz login."); return; }
            if (connection && connection.state === "Connected") { log("Ya conectado"); return; }

            connection = new signalR.HubConnectionBuilder()
                .withUrl(hubUrl, { accessTokenFactory: () => token })
                .withAutomaticReconnect()
                .build();

            connection.on("TaskCreated", (tarea) => {
                log("Notificacion: " + JSON.stringify(tarea));
            });

            connection.onclose(err => {
                log("Conexión cerrada. " + (err ? err : ""));
            });

            try {
                await connection.start();
                log("Conectado a SignalR");
            } catch (err) {
                log("Error al conectar: " + err);
            }
        });

        document.getElementById("btnDisconnect").addEventListener("click", async () => {
            if (connection) {
                await connection.stop();
                log("Desconectado.");
            }
        });


        document.getElementById("btnCreateTask").addEventListener("click", async () => {
            if (!token) { log("Necesitas token para crear tarea (haz login)."); return; }
            const tarea = {
                description: "Prueba exitosa desde cliente",
                dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // +1 día
                status: "Pendiente",
                priority: "Baja"
            };
            try {
                const res = await fetch(`${apiBaseUrl}/api/Tareas`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify(tarea)
                });
                const txt = await res.text();
                log("POST /api/Tareas -> " + res.status + " - " + txt);
            } catch (e) {
                log("Error creando tarea: " + e);
            }
        });
    </script>
</body>
</html>
